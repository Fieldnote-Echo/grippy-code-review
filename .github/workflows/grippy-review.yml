name: Grippy Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: Grippy Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b  # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.12'

      - name: Cache Grippy data
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5
        with:
          path: ./grippy-data
          key: grippy-data-${{ github.event.pull_request.number || 'manual' }}-${{ github.sha }}
          restore-keys: |
            grippy-data-${{ github.event.pull_request.number || 'manual' }}-

      - name: Install uv
        uses: astral-sh/setup-uv@5a095e7a2014a4212f075830d4f7277575a9d098  # v7.3.1
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra persistence

      - name: Run Grippy review
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GRIPPY_TRANSPORT: openai
          GRIPPY_BASE_URL: https://api.openai.com/v1
          GRIPPY_MODEL_ID: gpt-5.2
          GRIPPY_EMBEDDING_MODEL: text-embedding-3-large
          GRIPPY_DATA_DIR: ./grippy-data
          GRIPPY_TIMEOUT: '300'
        run: uv run python -m grippy

      - name: Review summary
        if: always()
        env:
          REVIEW_SCORE: ${{ steps.review.outputs.score }}
          REVIEW_VERDICT: ${{ steps.review.outputs.verdict }}
          REVIEW_FINDINGS: ${{ steps.review.outputs.findings-count }}
          REVIEW_BLOCKING: ${{ steps.review.outputs.merge-blocking }}
        run: |
          echo "### Grippy Review Results" >> "$GITHUB_STEP_SUMMARY"
          echo "- Score: $REVIEW_SCORE" >> "$GITHUB_STEP_SUMMARY"
          echo "- Verdict: $REVIEW_VERDICT" >> "$GITHUB_STEP_SUMMARY"
          echo "- Findings: $REVIEW_FINDINGS" >> "$GITHUB_STEP_SUMMARY"
          echo "- Merge blocking: $REVIEW_BLOCKING" >> "$GITHUB_STEP_SUMMARY"
